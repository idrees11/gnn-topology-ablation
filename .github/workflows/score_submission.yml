name: Score Submissions

on:
  pull_request_target:
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score"
        required: true

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  scoring:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # STEP 1: Checkout organiser repo (scoring code)
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4
        with:
          ref: main

      # -------------------------------------------------
      # STEP 2: Fetch PR HEAD correctly (CRITICAL FIX)
      # -------------------------------------------------
      - name: Fetch participant PR
        run: |
          PR_NUMBER=${{ github.event.pull_request.number || github.event.inputs.pr_number }}

          echo "Fetching PR #$PR_NUMBER"
          git fetch origin pull/$PR_NUMBER/head:participant_branch
          git checkout participant_branch

          echo "PR repo content:"
          ls -R

      # -------------------------------------------------
      # STEP 3: Copy submissions from PR
      # -------------------------------------------------
      - name: Copy submissions
        run: |
          mkdir -p submissions

          if [ ! -d "submissions" ]; then
            echo "‚ùå submissions folder not found in PR"
            exit 1
          fi

          echo "Submission files:"
          ls -l submissions

      # -------------------------------------------------
      # STEP 4: Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # -------------------------------------------------
      # STEP 5: Run scoring (SECRET FIXED)
      # -------------------------------------------------
      - name: Run scoring
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: python scoring_script.py

      # -------------------------------------------------
      # STEP 6: Update leaderboard
      # -------------------------------------------------
      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      # -------------------------------------------------
      # STEP 7: Commit leaderboard
      # -------------------------------------------------
      - name: Commit leaderboard
        run: |
          git config --global user.name "leaderboard-bot"
          git config --global user.email "bot@github.com"

          git add leaderboard/leaderboard.md scores.json || true
          git commit -m "Update leaderboard" || true
          git push
