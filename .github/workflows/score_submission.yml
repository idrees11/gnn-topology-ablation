name: Score Submissions

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -------------------------------------------------
  # 1. SCORING JOB (PR-safe, NO PUSH)
  # -------------------------------------------------
  scoring:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install pandas scikit-learn

      - name: Ensure submissions folder exists
        run: mkdir -p submissions

      - name: Create dummy submission if empty
        run: |
          if [ -z "$(ls -A submissions 2>/dev/null)" ]; then
            echo "graph_index,label" > submissions/dummy.csv
            echo "0,0" >> submissions/dummy.csv
          fi

      - name: Run scoring
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: |
          python scoring_script.py || echo "Scoring skipped (PR-safe)"

      - name: Update leaderboard (local only)
        run: |
          python leaderboard/leaderboard_system.py || true

      - name: Upload leaderboard artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leaderboard
          path: leaderboard/leaderboard.md

      # -------------------------------------------------
      # âœ… PR FEEDBACK (ADDED â€” NO OTHER CHANGES)
      # -------------------------------------------------
      - name: Comment on PR (submission received)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = `
            âœ… **Submission received successfully!**

            ðŸ”¹ Your submission has been detected.
            ðŸ”¹ Basic checks have been completed.
            ðŸ”¹ Final evaluation uses private labels and is run by the organisers.
            ðŸ”¹ The public leaderboard will be updated after evaluation.

            Thank you for participating ðŸš€
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # -------------------------------------------------
  # 2. COMMIT JOB (ONLY push to main)
  # -------------------------------------------------
  commit-leaderboard:
    needs: scoring
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch (NOT detached)
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "action@github.com"

          git add leaderboard/leaderboard.md
          git commit -m "Update leaderboard [skip ci]" || echo "No changes"

      - name: Push changes
        run: git push
