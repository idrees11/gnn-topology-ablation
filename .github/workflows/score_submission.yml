name: Score Submissions

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score manually"
        required: false

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  score:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # STEP 1: Checkout organiser repository
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # STEP 2: Determine PR number
      # -------------------------------------------------
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------
      # STEP 3: Download PR snapshot (ZIP)
      # -------------------------------------------------
      - name: Download PR snapshot
        run: |
          PR=${{ steps.pr.outputs.number }}
          echo "Downloading PR #$PR"

          curl -L \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR \
          | jq -r '.head.repo.zipball_url' > zip_url.txt

          ZIP_URL=$(cat zip_url.txt)
          echo "ZIP URL: $ZIP_URL"

          curl -L "$ZIP_URL" -o pr.zip
          unzip pr.zip -d pr_contents

          echo "Extracted PR contents:"
          ls -R pr_contents

      # -------------------------------------------------
      # STEP 4: Copy submission files (ROBUST FIX)
      # -------------------------------------------------
      - name: Copy submissions from PR
        run: |
          echo "Searching for submission files in PR..."

          mkdir -p submissions

          PR_SUB_DIR=$(find pr_contents -type d -name submissions | head -n 1)

          if [ -z "$PR_SUB_DIR" ]; then
            echo "‚ùå No submissions folder found in PR"
            exit 1
          fi

          echo "Found submissions at: $PR_SUB_DIR"
          ls -l "$PR_SUB_DIR"

          cp -v "$PR_SUB_DIR"/* submissions/ || true

          echo "Final submissions used for scoring:"
          ls -l submissions

      # -------------------------------------------------
      # STEP 5: Run scoring
      # -------------------------------------------------
      - name: Run scoring
        run: |
          python scoring_script.py

      # -------------------------------------------------
      # STEP 6: Update leaderboard
      # -------------------------------------------------
      - name: Update leaderboard
        run: |
          python leaderboard/leaderboard_system.py --scores scores.json

      # -------------------------------------------------
      # STEP 7: Commit leaderboard update
      # -------------------------------------------------
      - name: Commit leaderboard
        run: |
          git config --global user.name "leaderboard-bot"
          git config --global user.email "bot@github.com"

          git add leaderboard/leaderboard.md scores.json || true
          git commit -m "Update leaderboard from PR #${{ steps.pr.outputs.number }}" || true
          git push
