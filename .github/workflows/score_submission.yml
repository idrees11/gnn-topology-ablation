name: Score Submissions

on:
  pull_request_target:
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score manually"
        required: true

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  scoring:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # STEP 1: Checkout organiser repo (scoring code)
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4
        with:
          ref: main

      # -------------------------------------------------
      # STEP 2: Fetch participant PR branch
      # -------------------------------------------------
      - name: Fetch participant PR
        run: |
          PR_NUMBER=${{ github.event.pull_request.number || github.event.inputs.pr_number }}
          echo "Fetching PR #$PR_NUMBER"

          git fetch origin pull/$PR_NUMBER/head:participant_branch
          git checkout participant_branch

          echo "PR repo structure:"
          ls -R

      # -------------------------------------------------
      # STEP 3: Locate submissions folder dynamically
      # -------------------------------------------------
      - name: Locate submissions folder
        run: |
          SUB_DIR=$(find . -type d -name submissions | head -n 1)

          if [ -z "$SUB_DIR" ]; then
            echo "âŒ submissions folder not found"
            exit 1
          fi

          echo "Found submissions folder at: $SUB_DIR"
          ls -l "$SUB_DIR"

      # -------------------------------------------------
      # STEP 4: Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # -------------------------------------------------
      # STEP 5: Decode private labels
      # -------------------------------------------------
      - name: Decode private labels
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: |
          echo "$TEST_LABELS_B64" | base64 -d > test_labels.csv
          echo "Private labels loaded"

      # -------------------------------------------------
      # STEP 6: Run scoring using dynamic submissions path
      # -------------------------------------------------
      - name: Run scoring
        run: |
          SUB_DIR=$(find . -type d -name submissions | head -n 1)
          echo "Using submissions folder: $SUB_DIR"
          ls -l "$SUB_DIR"

          python scoring_script.py test_labels.csv "$SUB_DIR/ideal_submission.csv"
          python scoring_script.py test_labels.csv "$SUB_DIR/perturbed_submission.csv"

      # -------------------------------------------------
      # STEP 7: Update leaderboard
      # -------------------------------------------------
      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      # -------------------------------------------------
      # STEP 8: Commit leaderboard
      # -------------------------------------------------
      - name: Commit leaderboard
        run: |
          git config --global user.name "leaderboard-bot"
          git config --global user.email "bot@github.com"

          git add leaderboard/leaderboard.md scores.json || true
          git commit -m "Update leaderboard from PR" || true
          git push
