name: Score Submissions

on:
  pull_request:
    branches: [main]
  pull_request_target:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
# -------------------------------------------------
# 1. SCORING JOB (PR-safe, NO PUSH)
# -------------------------------------------------
  scoring:
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ Safe checkout of PR files
      - name: Checkout PR files
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Show repo structure (debug)
        run: |
          echo "Repo files:"
          ls -R

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # ‚úÖ Verify submission files exist
      - name: Check submission files
        id: check_files
        run: |
          if [ -f submissions/ideal_submission.csv ] && [ -f submissions/perturbed_submission.csv ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Submission files found"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "‚ùå Required submission files missing"
          fi

      # ‚úÖ Run scoring only if valid
      - name: Run scoring
        if: steps.check_files.outputs.valid == 'true'
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: python scoring_script.py

      - name: Upload scores artifact
        if: steps.check_files.outputs.valid == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: scores-json
          path: scores.json

      - name: Update leaderboard locally
        if: steps.check_files.outputs.valid == 'true'
        run: python leaderboard/leaderboard_system.py --scores scores.json

      - name: Upload leaderboard artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leaderboard
          path: leaderboard/leaderboard.md

# -------------------------------------------------
# 2. COMMIT JOB (ONLY ORGANIZER PUSHES)
# -------------------------------------------------
  commit-leaderboard:
    needs: scoring
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download leaderboard artifact
        uses: actions/download-artifact@v4
        with:
          name: leaderboard
          path: leaderboard

      - name: Commit and push leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add leaderboard/leaderboard.md
          git diff --cached --quiet || git commit -m "Update leaderboard [skip ci]"
          git pull --rebase origin main
          git push

# -------------------------------------------------
# 3. PR FEEDBACK JOB (PARTICIPANT MESSAGE)
# -------------------------------------------------
  pr-feedback:
    needs: scoring
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = `
‚úÖ Submission received successfully!

Your PR has been processed.

If your files were valid:
‚Ä¢ Ideal submission scored
‚Ä¢ Perturbed submission scored
‚Ä¢ Results recorded for leaderboard update

üìä Check:
Actions ‚Üí Latest run ‚Üí scoring job logs

If files were missing, please ensure:
submissions/ideal_submission.csv  
submissions/perturbed_submission.csv
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
