name: Score Submissions 

on:
  pull_request_target:
    branches: [main]

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score"
        required: false

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:

  # -------------------------------------------------
  # ✅ Comment on PR feedback
  # -------------------------------------------------
  pr-feedback:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: "✅ Submission received! Your model will be evaluated securely on hidden test labels."
            });

  # -------------------------------------------------
  # ✅ Scoring job
  # -------------------------------------------------
  scoring:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:

      # -------------------------------------------------
      # Checkout organiser repo
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4
        with:
          ref: main

      # -------------------------------------------------
      # Checkout participant PR
      # -------------------------------------------------
      - name: Checkout participant PR
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          path: participant_repo

      # -------------------------------------------------
      # Copy only ideal and perturbed submissions
      # -------------------------------------------------
      - name: Copy submissions
        run: |
          mkdir -p submissions
          for file in ideal_submission.csv perturbed_submission.csv; do
            if [ -f "participant_repo/submissions/$file" ]; then
              cp "participant_repo/submissions/$file" submissions/
            else
              echo "Missing submission: $file"
            fi
          done

      # -------------------------------------------------
      # Show submissions (debug)
      # -------------------------------------------------
      - name: Show submissions
        run: ls -R submissions || echo "No submissions found"

      # -------------------------------------------------
      # Decrypt AES key (optional)
      # -------------------------------------------------
      - name: Decrypt AES key
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          if [ -f submissions/aes_key.enc ]; then
            echo "$PRIVATE_KEY" > private_key.pem
            openssl pkeyutl -decrypt -inkey private_key.pem -in submissions/aes_key.enc -out submissions/aes_key.hex
            echo "AES key decrypted successfully"
          else
            echo "No AES key found, skipping decryption"
          fi

      # -------------------------------------------------
      # Decrypt encrypted CSVs using AES key
      # -------------------------------------------------
      - name: Decrypt submissions (AES)
        run: |
          if compgen -G "submissions/*.enc" > /dev/null; then
            for file in submissions/*.enc; do
              if [ "$file" != "submissions/aes_key.enc" ]; then
                output_file="${file%.enc}.csv"
                echo "Decrypting $file → $output_file"
                openssl enc -aes-256-cbc -d -pbkdf2 -in "$file" -out "$output_file" -pass file:submissions/aes_key.hex
              fi
            done
          else
            echo "No encrypted CSVs found, skipping AES decryption"
          fi

      # -------------------------------------------------
      # Python setup
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # -------------------------------------------------
      # Determine participant name
      # -------------------------------------------------
      - name: Set participant name
        id: participant
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "participant_name=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          else
            echo "participant_name=manual_run" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # Run scoring
      # -------------------------------------------------
      - name: Run scoring
        env:
          TEST_LABELS_RAW: ${{ secrets.TEST_LABELS_B64 }}
        run: |
          export TEST_LABELS_B64=$(echo "$TEST_LABELS_RAW" | base64 | tr -d '\n')
          python scoring_script.py \
            --save-scores scores.json \
            --participant "${{ steps.participant.outputs.participant_name }}"

      # -------------------------------------------------
      # Update leaderboard
      # -------------------------------------------------
      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      # -------------------------------------------------
      # Commit leaderboard safely
      # -------------------------------------------------
      - name: Commit leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add leaderboard/

          if ! git diff --cached --quiet; then
            git commit -m "Update leaderboard history [skip ci]"
          fi

          git stash --include-untracked 
          git pull origin main --no-rebase
          git stash pop || true
          git push origin main
