name: Score Submissions

on:
  pull_request_target:
    branches: [main]
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:

  # -------------------------------------------------
  # 1Ô∏è‚É£ PR CONFIRMATION (participants see this)
  # -------------------------------------------------
  pr-feedback:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Confirm submission received
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = [
              "‚úÖ Submission received successfully!",
              "",
              "Your files were detected in submissions/.",
              "",
              "What happens next:",
              "‚Ä¢ Organizer will run scoring using private labels",
              "‚Ä¢ Leaderboard will be updated automatically",
              "‚Ä¢ You can track progress in the Actions tab",
              "",
              "Thank you for participating in the GNN Topology Ablation Challenge üöÄ"
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # -------------------------------------------------
  # 2Ô∏è‚É£ SCORING (ONLY ORGANIZER RUNS THIS)
  # -------------------------------------------------
  scoring:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout organiser repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      - name: Ensure submissions folder exists
        run: mkdir -p submissions

      - name: List submissions
        run: ls -R submissions || echo "No submissions found"

      - name: Run scoring (ideal + perturbed)
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: python scoring_script.py --save-scores scores.json

      - name: Show scores
        run: cat scores.json || echo "No scores generated"

      - name: Update leaderboard
        run: |
          if [ -f scores.json ]; then
            python leaderboard/leaderboard_system.py --scores scores.json
          fi

      - name: Upload leaderboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: leaderboard
          path: leaderboard/leaderboard.md

  # -------------------------------------------------
  # 3Ô∏è‚É£ COMMIT UPDATED LEADERBOARD
  # -------------------------------------------------
  commit-leaderboard:
    needs: scoring
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download leaderboard artifact
        uses: actions/download-artifact@v4
        with:
          name: leaderboard
          path: leaderboard

      - name: Commit and push leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add leaderboard/leaderboard.md
          git diff --cached --quiet || git commit -m "Update leaderboard [skip ci]"
          git pull --rebase origin main
          git push
