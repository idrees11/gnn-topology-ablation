name: Score Submissions

on:
  pull_request_target:
    branches: [main]

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score"
        required: true

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:

  # -------------------------------------------------
  # ✅ Participant confirmation message
  # -------------------------------------------------
  pr-feedback:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: "✅ Submission received successfully! It will be evaluated automatically."
            });

  # -------------------------------------------------
  # ✅ Scoring job
  # -------------------------------------------------
  scoring:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request_target'

    steps:
      # -------------------------------------------------
      # STEP 1: Checkout organiser repo (scoring code)
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4
        with:
          ref: main

      # -------------------------------------------------
      # STEP 2: Determine PR number
      # -------------------------------------------------
      - name: Set PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "PR=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "PR=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------
      # STEP 3: Download PR snapshot (CORRECT METHOD)
      # -------------------------------------------------
      - name: Download PR contents
        run: |
          echo "Downloading PR #${{ steps.pr.outputs.PR }}"

          curl -L \
            -o pr.zip \
            https://github.com/${{ github.repository }}/archive/refs/pull/${{ steps.pr.outputs.PR }}/head.zip

          unzip pr.zip -d pr_contents

      # -------------------------------------------------
      # STEP 4: Debug — show downloaded files
      # -------------------------------------------------
      - name: Show PR files
        run: ls -R pr_contents || echo "No PR files found"

      # -------------------------------------------------
      # STEP 5: Copy submission files
      # -------------------------------------------------
      - name: Copy submissions
        run: |
          mkdir -p submissions
          cp -v pr_contents/*/submissions/* submissions/ || echo "No submission files found"

      - name: Show scoring files
        run: ls -R submissions || echo "No submissions folder"

      # -------------------------------------------------
      # STEP 6: Python setup
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # -------------------------------------------------
      # STEP 7: Run scoring
      # -------------------------------------------------
      - name: Run scoring
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: python scoring_script.py

      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      - name: Upload leaderboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: leaderboard
          path: leaderboard/leaderboard.md

  # -------------------------------------------------
  # ✅ Commit leaderboard (manual scoring only)
  # -------------------------------------------------
  commit-leaderboard:
    needs: scoring
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          name: leaderboard
          path: leaderboard

      - name: Commit leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add leaderboard/leaderboard.md
          git diff --cached --quiet || git commit -m "Update leaderboard [skip ci]"
          git pull --rebase origin main
          git push
