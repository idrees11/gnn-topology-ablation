name: Score Submissions

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to score manually"
        required: false

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  score:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # STEP 1: Checkout organiser repo (scoring code)
      # -------------------------------------------------
      - name: Checkout organiser repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # STEP 2: Checkout PR contributor repo (REAL FIX)
      # -------------------------------------------------
      - name: Checkout participant PR code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          path: participant_repo

      # Manual trigger support
      - name: Checkout participant PR manually
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.inputs.pr_number }}/head
          path: participant_repo

      # -------------------------------------------------
      # STEP 3: Copy submissions folder
      # -------------------------------------------------
      - name: Copy submissions
        run: |
          echo "Participant repo structure:"
          ls -R participant_repo

          mkdir -p submissions

          if [ ! -d "participant_repo/submissions" ]; then
            echo "‚ùå submissions folder not found in PR"
            exit 1
          fi

          cp -v participant_repo/submissions/* submissions/ || true

          echo "Final submissions used for scoring:"
          ls -l submissions

      # -------------------------------------------------
      # STEP 4: Setup Python
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      # -------------------------------------------------
      # STEP 5: Run scoring
      # -------------------------------------------------
      - name: Run scoring
        run: python scoring_script.py

      # -------------------------------------------------
      # STEP 6: Update leaderboard
      # -------------------------------------------------
      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      # -------------------------------------------------
      # STEP 7: Commit leaderboard
      # -------------------------------------------------
      - name: Commit leaderboard
        run: |
          git config --global user.name "leaderboard-bot"
          git config --global user.email "bot@github.com"

          git add leaderboard/leaderboard.md scores.json || true
          git commit -m "Update leaderboard from PR" || true
          git push
