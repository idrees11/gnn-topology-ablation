name: Score Submissions

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:

  # -------------------------------------------------
  # 1. SCORING JOB (organiser only, has secrets)
  # -------------------------------------------------
  scoring:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3

      - name: Show repo structure
        run: |
          echo "Repo structure:"
          ls -R

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install pandas scikit-learn

      - name: Verify submissions exist
        run: |
          ls submissions || echo "No submissions folder found"

      - name: Run scoring (ideal + perturbed)
        env:
          TEST_LABELS_B64: ${{ secrets.TEST_LABELS_B64 }}
        run: python scoring_script.py

      - name: Update leaderboard
        run: python leaderboard/leaderboard_system.py --scores scores.json

      - name: Commit leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add leaderboard/leaderboard.md
          git diff --cached --quiet || git commit -m "Update leaderboard [skip ci]"
          git push
